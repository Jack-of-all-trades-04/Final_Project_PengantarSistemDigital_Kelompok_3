library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use IEEE.NUMERIC_STD.ALL;
use work.block_header.all;  

library ieee;
use ieee.std_logic_1164.all;
use ieee.numeric_std.all;

entity miner is
    port(
        clk             : in  std_logic;
        reset           : in  std_logic;
        prev_header_in  : in  std_logic_vector(66 downto 0);
        miner_id_in     : in  std_logic_vector(7 downto 0); -- menentukan seed LFSR
        target_bits     : in  std_logic_vector(63 downto 0);

        block_found     : out std_logic;
        mined_block_out : out std_logic_vector(66 downto 0)
    );
end entity;

architecture Behavioral of miner is

    signal nonce    : unsigned(31 downto 0) := (others => '0');
    signal lfsr     : std_logic_vector(15 downto 0) := (others => '1');

    signal hash_val : std_logic_vector(63 downto 0);
    signal found    : std_logic := '0';

begin
    process(clk)
    begin
        if rising_edge(clk) then
            if reset = '1' then
                lfsr <= miner_id_in & "10101010";
            else
                lfsr <= lfsr(14 downto 0) & (lfsr(15) xor lfsr(13));
            end if;
        end if;
    end process;
    process(clk)
    begin
        if rising_edge(clk) then
            if reset = '1' then
                nonce <= (others => '0');
            else
               nonce <= nonce + 1 + to_integer(unsigned(miner_id_in(1 downto 0)));
            end if;
        end if;
    end process;

   hash_val <= std_logic_vector(
                rotate_left(
                    unsigned(prev_header_in(63 downto 0))
                    xor resize(unsigned(lfsr & lfsr), 64)
                    xor resize(nonce, 64),
                    7
                )
            );


    process(clk)
    begin
        if rising_edge(clk) then
            if reset = '1' then
                found <= '0';
            else
                if hash_val < target_bits then
                    found <= '1';
                else
                    found <= '0';
                end if;
            end if;
        end if;
    end process;

    block_found <= found;
    mined_block_out <= prev_header_in when found = '1' else (others => '0');

end architecture;

